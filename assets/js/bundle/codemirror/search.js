!function(e){"object"==typeof exports&&"object"==typeof module?e(require("codemirror"),require("searchcursor"),require("dialog")):"function"==typeof define&&define.amd?define(["codemirror","searchcursor","dialog"],e):e(CodeMirror)}(function(e){"use strict";function n(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new n)}function o(e){return"string"==typeof e&&e==e.toLowerCase()}function t(e,n,r){return e.getSearchCursor(n,r,{caseFold:o(n),multiline:!0})}function a(e,n,r,o,t){e.openDialog?e.openDialog(n,t,{value:o,selectValueOnOpen:!0}):t(prompt(r,o))}function i(e){return e.replace(/\\([nrt\\])/g,function(e,n){return"n"==n?"\n":"r"==n?"\r":"t"==n?"\t":"\\"==n?"\\":e})}function s(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=i(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function c(e,n,r){n.queryText=r,n.query=s(r),e.removeOverlay(n.overlay,o(n.query)),n.overlay=function(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var r=e.exec(n.string);if(r&&r.index==n.pos)return n.pos+=r[0].length||1,"searching";r?n.pos=r.index:n.skipToEnd()}}}(n.query,o(n.query)),e.addOverlay(n.overlay),e.showMatchesOnScrollbar&&(n.annotate&&(n.annotate.clear(),n.annotate=null),n.annotate=e.showMatchesOnScrollbar(n.query,o(n.query)))}function l(n,o,t,i){var s=r(n);if(s.query)return u(n,o);var l=n.getSelection()||s.lastQuery;if(l instanceof RegExp&&"x^"==l.source&&(l=null),t&&n.openDialog){var d=null,y=function(r,o){e.e_stop(o),r&&(r!=s.queryText&&(c(n,s,r),s.posFrom=s.posTo=n.getCursor()),d&&(d.style.opacity=1),u(n,o.shiftKey,function(e,r){var o;r.line<3&&document.querySelector&&(o=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&o.getBoundingClientRect().bottom-4>n.cursorCoords(r,"window").top&&((d=o).style.opacity=.4)}))};!function(e,n,r,o,t){e.openDialog(n,o,{value:r,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){f(e)},onKeyDown:t})}(n,p(n),l,y,function(o,t){var a=e.keyName(o),i=n.getOption("extraKeys"),s=i&&i[a]||e.keyMap[n.getOption("keyMap")][a];"findNext"==s||"findPrev"==s||"findPersistentNext"==s||"findPersistentPrev"==s?(e.e_stop(o),c(n,r(n),t),n.execCommand(s)):"find"!=s&&"findPersistent"!=s||(e.e_stop(o),y(t,o))}),i&&l&&(c(n,s,l),u(n,o))}else a(n,p(n),"Search for:",l,function(e){e&&!s.query&&n.operation(function(){c(n,s,e),s.posFrom=s.posTo=n.getCursor(),u(n,o)})})}function u(n,o,a){n.operation(function(){var i=r(n),s=t(n,i.query,o?i.posFrom:i.posTo);(s.find(o)||(s=t(n,i.query,o?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(o))&&(n.setSelection(s.from(),s.to()),n.scrollIntoView({from:s.from(),to:s.to()},20),i.posFrom=s.from(),i.posTo=s.to(),a&&a(s.from(),s.to()))})}function f(e){e.operation(function(){var n=r(e);n.lastQuery=n.query,n.query&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))})}function p(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function d(e,n,r){e.operation(function(){for(var o=t(e,n);o.findNext();)if("string"!=typeof n){var a=e.getRange(o.from(),o.to()).match(n);o.replace(r.replace(/\$(\d)/g,function(e,n){return a[n]}))}else o.replace(r)})}function y(e,n){if(!e.getOption("readOnly")){var o=e.getSelection()||r(e).lastQuery,c='<span class="CodeMirror-search-label">'+(n?e.phrase("Replace all:"):e.phrase("Replace:"))+"</span>";a(e,c+function(e){return' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}(e),c,o,function(r){r&&(r=s(r),a(e,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>'}(e),e.phrase("Replace with:"),"",function(o){if(o=i(o),n)d(e,r,o);else{f(e);var a=t(e,r,e.getCursor("from")),s=function(){var n,i=a.from();!(n=a.findNext())&&(a=t(e,r),!(n=a.findNext())||i&&a.from().line==i.line&&a.from().ch==i.ch)||(e.setSelection(a.from(),a.to()),e.scrollIntoView({from:a.from(),to:a.to()}),function(e,n,r,o){e.openConfirm?e.openConfirm(n,o):confirm(r)&&o[0]()}(e,function(e){return'<span class="CodeMirror-search-label">'+e.phrase("Replace?")+"</span> <button>"+e.phrase("Yes")+"</button> <button>"+e.phrase("No")+"</button> <button>"+e.phrase("All")+"</button> <button>"+e.phrase("Stop")+"</button> "}(e),e.phrase("Replace?"),[function(){c(n)},s,function(){d(e,r,o)}]))},c=function(e){a.replace("string"==typeof r?o:o.replace(/\$(\d)/g,function(n,r){return e[r]})),s()};s()}}))})}}e.commands.find=function(e){f(e),l(e)},e.commands.findPersistent=function(e){f(e),l(e,!1,!0)},e.commands.findPersistentNext=function(e){l(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){l(e,!0,!0,!0)},e.commands.findNext=l,e.commands.findPrev=function(e){l(e,!0)},e.commands.clearSearch=f,e.commands.replace=y,e.commands.replaceAll=function(e){y(e,!0)}});